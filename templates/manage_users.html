{% extends "layout.html" %}

{% block title %}Gerenciar Usuários | SentinelVision{% endblock %}

{% block head_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manage_users.css') }}">
{% endblock %}

{% block content %}
    <h1>Gerenciamento de Usuários</h1>
    <p class="subtitle">Crie, visualize e remova contas de acesso ao sistema.</p>

    <div class="form-panel">
        <h2>Criar Novo Usuário</h2>
        <form id="create-user-form" method="POST" action="{{ url_for('manage_users') }}">
            
            <div class="form-group">
                <label for="username">Nome de Usuário *</label>
                <input id="username" type="text" name="username" required>
            </div>

            <div class="form-group">
                <label for="password">Senha de Acesso *</label>
                <input id="password" type="text" name="password" required readonly>
                <button type="button" id="generate-password-btn" class="generate-btn" style="margin-top: 10px;">
                    Gerar Senha
                </button>
            </div>
            
            <div class="form-group">
                <label for="expiration_type">Duração do Acesso *</label>
                <select id="expiration_type" name="expiration_type" required>
                    <option value="permanent">Permanente (Vitalício)</option>
                    <option value="1_day">1 Dia</option>
                    <option value="1_month">1 Mês</option>
                    <option value="1_year">1 Ano</option>
                </select>
            </div>
            
            <button type="submit" class="submit-btn">Criar Usuário</button>
        </form>
    </div>

    <div class="table-panel">
        <h2>Usuários Ativos no Sistema</h2>
        <table class="users-table">
            <thead>
                <tr>
                    <th>Usuário</th>
                    <th>Expiração</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td data-label="Usuário">{{ user.username }}</td>
                    <td data-label="Expiração">
                        {% if user.expiration_date %}
                            {{ user.expiration_date.strftime('%d/%m/%Y às %H:%M') }} (UTC)
                        {% else %}
                            <span class="status-vitalicio">Vitalício</span>
                        {% endif %}
                    </td>
                    <td data-label="Ação">
                        {% if user.id != 1 %}
                            <div class="user-actions">
                                <a href="{{ url_for('reset_user_password', user_id=user.id) }}" class="reset-password-button">Redefinir Senha</a>
                                <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja deletar o usuário {{ user.username }}?');" style="margin: 0;">
                                    <button type="submit" class="delete-button-danger">Deletar</button>
                                </form>
                            </div>
                        {% else %}
                            <span>-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-password-btn'); 
    const passwordInput = document.getElementById('password');

    function generateRandomString(length, chars) {
        let result = '';
        for (let i = 0; i < length; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return result;
    }

    function generateAndSetPassword() { 
        const password = generateRandomString(12, 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*');
        passwordInput.value = password;
    }

    generateBtn.addEventListener('click', generateAndSetPassword);
});
</script>
{% endblock %}