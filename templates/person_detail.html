{% extends "layout.html" %}

{% block title %}Galeria: {{ person.name }}{% endblock %}

{% block head_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/detail_gallery.css') }}">
{% endblock %}

{% block content %}
    <div class="detail-header">
        <h1>Galeria do Indivíduo</h1>
        <a href="{{ url_for('gallery') }}" class="back-link">&laquo; Voltar para a Galeria Principal</a>
    </div>

    <div class="dossier-grid">
        <div class="dossier-info-panel">
            <div class="dossier-main-info">
                {% set profile_photo = person.photos|selectattr('photo_type', 'equalto', 'profile')|first %}
                {% if profile_photo %}
                    <img src="{{ url_for('static', filename='db_images/' + profile_photo.filename) }}" alt="Foto de {{ person.name }}">
                {% endif %}
                <h2>{{ person.name }}</h2>
                <p>Status: <span class="status-{{ person.status|lower|replace(' ', '-') }}">{{ person.status }}</span></p>
            </div>
            
            <div class="dossier-actions">
                <a href="{{ url_for('edit_person', person_id=person.id) }}" class="edit-button">Editar Dossiê</a>
                <form action="{{ url_for('delete', person_id=person.id) }}" method="POST" onsubmit="return confirm('ATENÇÃO: Deseja deletar permanentemente o perfil de {{ person.name }}?');">
                    <button type="submit" class="delete-button">Deletar Perfil</button>
                </form>
            </div>
            
            <div class="dossier-details">
                <h3>Detalhes Pessoais</h3>
                <ul>
                    <li><strong>Nº Documento:</strong> <span>{{ person.doc_number or 'Não informado' }}</span></li>
                    <li><strong>Data de Nasc.:</strong> <span>{{ person.date_of_birth.strftime('%d/%m/%Y') if person.date_of_birth else 'Não informado' }}</span></li>
                    <li><strong>Gênero:</strong> <span>{{ person.gender or 'Não informado' }}</span></li>
                    <li><strong>Endereço:</strong> <span>{{ person.address or 'Não informado' }}</span></li>
                </ul>
                <h3>Contatos</h3>
                <ul>
                    <li><strong>Telefone(s):</strong> <span>{{ person.phones or 'Não informado' }}</span></li>
                    <li><strong>E-mail(s):</strong> <span>{{ person.emails or 'Não informado' }}</span></li>
                </ul>
                <h3>Parentesco</h3>
                <ul>
                    <li><strong>Pai:</strong> <span>{{ person.father_name or 'Não informado' }}</span></li>
                    <li><strong>Mãe:</strong> <span>{{ person.mother_name or 'Não informado' }}</span></li>
                    <li><strong>Cônjuge(s):</strong> <span>{{ person.spouse or 'Não informado' }}</span></li>
                    <li><strong>Filho(s):</strong> <span>{{ person.children or 'Não informado' }}</span></li>
                </ul>
                <h3>Observações</h3>
                <div class="notes-box">
                    <p>{{ person.notes or "Nenhuma observação registrada." }}</p>
                </div>
            </div>
        </div>

        <div class="gallery-panel">
            <h3 class="sighting-title">Adicionar Nova Imagem</h3>
            <div class="add-photo-container">
                <form id="add-photo-form" method="POST" action="{{ url_for('add_photo_to_person', person_id=person.id) }}" enctype="multipart/form-data">
                    <input type="file" id="new_photo" name="new_photo" accept="image/*" required style="display: none;">
                    
                    <label for="new_photo" class="custom-file-upload">
                        <span class="upload-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        </span>
                        <span id="add-photo-file-chosen-text" class="custom-file-upload-text">
                            Clique aqui ou arraste a imagem
                        </span>
                    </label>
                    
                    <button type="submit" class="add-photo-btn">Adicionar Foto</button>
                </form>
            </div>
            
            <h3 class="sighting-title">Histórico de Fotos</h3>
            <div class="sighting-gallery">
                {% for photo in person.photos %}
                    <div class="sighting-card">
                        <a href="{{ url_for('static', filename='db_images/' + photo.filename) if photo.photo_type == 'profile' else url_for('static', filename='sighting_images/' + photo.filename) }}" target="_blank">
                            <img src="{{ url_for('static', filename='db_images/' + photo.filename) if photo.photo_type == 'profile' else url_for('static', filename='sighting_images/' + photo.filename) }}" alt="Foto de {{ person.name }}">
                        </a>
                        <small>{{ photo.upload_date.strftime('%d/%m/%Y %H:%M') }}</small>
                    </div>
                {% else %}
                    <p>Nenhuma foto registrada.</p>
                {% endfor %}
            </div>

            <h3 class="similar-title">Rostos Semelhantes Encontrados</h3>
            <div class="similar-faces-gallery">
                {% for similar in similar_people %}
                <a href="{{ url_for('person_detail', person_id=similar.id) }}" class="profile-card-link">
                    <div class="profile-card">
                        {% set sim_profile_photo = similar.photos|selectattr('photo_type', 'equalto', 'profile')|first %}
                        {% if sim_profile_photo %}
                            <img src="{{ url_for('static', filename='db_images/' + sim_profile_photo.filename) }}" alt="Foto de {{ similar.name }}">
                        {% endif %}
                        <div class="card-content">
                            <h4>{{ similar.name }}</h4>
                        </div>
                    </div>
                </a>
                {% else %}
                    <p>Nenhum perfil semelhante encontrado.</p>
                {% endfor %}
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('new_photo');
    const fileChosenText = document.getElementById('add-photo-file-chosen-text'); 
    const dropArea = document.querySelector('.custom-file-upload');

    // Função para atualizar o nome do arquivo no texto
    function updateFileText(file) {
        if (file) {
            fileChosenText.textContent = file.name;
        } else {
            fileChosenText.textContent = 'Clique aqui ou arraste a imagem';
        }
    }

    // Evento de mudança para quando o usuário seleciona um arquivo
    fileInput.addEventListener('change', function() {
        updateFileText(this.files[0]);
    });

    // Eventos de drag-and-drop
    dropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropArea.classList.add('drag-over');
        fileChosenText.textContent = 'Solte a imagem aqui';
    });

    dropArea.addEventListener('dragleave', () => {
        dropArea.classList.remove('drag-over');
        updateFileText(fileInput.files[0]);
    });

    dropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        dropArea.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            updateFileText(files[0]);
        }
    });

    // Validação do formulário para garantir que um arquivo foi selecionado
    const addPhotoForm = document.getElementById('add-photo-form');
    addPhotoForm.addEventListener('submit', function(e) {
        if (fileInput.files.length === 0) {
            e.preventDefault();
            alert('Por favor, selecione uma imagem para adicionar.');
        }
    });
});
</script>
{% endblock %}
